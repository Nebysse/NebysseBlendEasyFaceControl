<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rigify æ‰©å±•å¼€å‘æŒ‡å—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 30px;
        }

        /* ä¾§è¾¹æ ç›®å½• */
        .sidebar {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .toc {
            list-style: none;
        }

        .toc li {
            margin-bottom: 8px;
        }

        .toc a {
            color: #555;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            display: block;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .toc a:hover {
            background-color: #e8f4f8;
            color: #2980b9;
            transform: translateX(5px);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 40px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            color: #2c3e50;
            font-size: 36px;
            margin-bottom: 30px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            color: #34495e;
            font-size: 28px;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
            position: relative;
        }

        h2::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: #e74c3c;
        }

        h3 {
            color: #2980b9;
            font-size: 22px;
            margin: 25px 0 15px 0;
        }

        h4 {
            color: #8e44ad;
            font-size: 18px;
            margin: 20px 0 10px 0;
        }

        /* æ®µè½å’Œåˆ—è¡¨ */
        p {
            margin-bottom: 15px;
            text-align: justify;
        }

        ul, ol {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin-bottom: 8px;
        }

        /* ä»£ç å—æ ·å¼ */
        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        code {
            background: #f1f5f9;
            color: #e53e3e;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        pre code {
            background: none;
            color: inherit;
            padding: 0;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        th {
            background: #3498db;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        /* è­¦å‘Šæ¡†æ ·å¼ */
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 5px solid #fdcb6e;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .warning::before {
            content: "âš ï¸ ";
            font-weight: bold;
            color: #d63031;
        }

        /* ä¿¡æ¯æ¡†æ ·å¼ */
        .info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-left: 5px solid #2196f3;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .info::before {
            content: "ğŸ’¡ ";
            font-weight: bold;
            color: #1976d2;
        }

        /* æˆåŠŸæ¡†æ ·å¼ */
        .success {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-left: 5px solid #4caf50;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .success::before {
            content: "âœ… ";
            font-weight: bold;
            color: #388e3c;
        }

        /* å±‚çº§ç»“æ„æ˜¾ç¤º */
        .hierarchy {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 15px;
            }

            .sidebar {
                position: static;
                max-height: none;
            }

            .main-content {
                padding: 25px;
            }

            h1 {
                font-size: 28px;
            }

            h2 {
                font-size: 24px;
            }

            pre {
                padding: 15px;
                font-size: 13px;
            }
        }

        /* å¹³æ»‘æ»šåŠ¨ */
        html {
            scroll-behavior: smooth;
        }

        /* é¡µé¢é¡¶éƒ¨é—´è· */
        section {
            scroll-margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ ç›®å½• -->
        <nav class="sidebar">
            <h3>ğŸ“– ç›®å½•å¯¼èˆª</h3>
            <ul class="toc">
                <li><a href="#å¼€å‘å‰å‡†å¤‡">1. å¼€å‘å‰å‡†å¤‡</a></li>
                <li><a href="#æ ¸å¿ƒæ³¨æ„äº‹é¡¹">2. æ ¸å¿ƒæ³¨æ„äº‹é¡¹</a></li>
                <li><a href="#é¡¹ç›®ç»“æ„è§„èŒƒ">3. é¡¹ç›®ç»“æ„è§„èŒƒ</a></li>
                <li><a href="#æ ¸å¿ƒåŠŸèƒ½å‡½æ•°è¯¦è§£">4. æ ¸å¿ƒåŠŸèƒ½å‡½æ•°è¯¦è§£</a></li>
                <li><a href="#å‚æ•°ç³»ç»Ÿä½¿ç”¨">5. å‚æ•°ç³»ç»Ÿä½¿ç”¨</a></li>
                <li><a href="#çº¦æŸå’Œé©±åŠ¨å™¨ç®¡ç†">6. çº¦æŸå’Œé©±åŠ¨å™¨ç®¡ç†</a></li>
                <li><a href="#è°ƒè¯•å’Œé”™è¯¯å¤„ç†">7. è°ƒè¯•å’Œé”™è¯¯å¤„ç†</a></li>
                <li><a href="#æœ€ä½³å®è·µ">8. æœ€ä½³å®è·µ</a></li>
                <li><a href="#æ€»ç»“">9. æ€»ç»“</a></li>
            </ul>
        </nav>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <h1>Rigify æ‰©å±•å¼€å‘æŒ‡å—</h1>

            <section id="å¼€å‘å‰å‡†å¤‡">
                <h2>å¼€å‘å‰å‡†å¤‡</h2>
                
                <h3>ç¯å¢ƒè¦æ±‚</h3>
                <ul>
                    <li><strong>Blenderç‰ˆæœ¬</strong>: 4.1+</li>
                    <li><strong>Pythonç‰ˆæœ¬</strong>: 3.10+</li>
                    <li><strong>å¿…éœ€æ’ä»¶</strong>: Rigify (å·²å¯ç”¨)</li>
                </ul>

                <h3>åŸºç¡€çŸ¥è¯†è¦æ±‚</h3>
                <ul>
                    <li>Python é¢å‘å¯¹è±¡ç¼–ç¨‹</li>
                    <li>Blender API (bpy) åŸºç¡€</li>
                    <li>Rigify æ¡†æ¶ç»“æ„ç†è§£</li>
                    <li>éª¨éª¼ç³»ç»Ÿå’Œçº¦æŸåŸç†</li>
                </ul>
            </section>

            <section id="æ ¸å¿ƒæ³¨æ„äº‹é¡¹">
                <h2>æ ¸å¿ƒæ³¨æ„äº‹é¡¹</h2>

                <h3>1. ç›®å½•ç»“æ„ä¸¥æ ¼è¦æ±‚</h3>
                <pre><code>ä½ çš„æ‰©å±•å/
â”œâ”€â”€ rigs/                    # å¿…éœ€ - ä¸»è¦ç»‘å®šæ¨¡å—
â”‚   â”œâ”€â”€ ä¸»æ§åˆ¶å™¨.py           # å‘½åè§„èŒƒ: åŠŸèƒ½_ç”¨é€”.py
â”‚   â”œâ”€â”€ å­æ§åˆ¶å™¨_l.py         # å·¦å³åˆ†ç¦»æ—¶ä½¿ç”¨ _l/_r åç¼€
â”‚   â”œâ”€â”€ å­æ§åˆ¶å™¨_r.py
â”‚   â”œâ”€â”€ åŸºç¡€ç±».py             # å…±äº«åŸºç¡€ç±»
â”‚   â””â”€â”€ utils/               # å·¥å…·æ¨¡å—ç›®å½•
â”œâ”€â”€ templates/               # å¯é€‰ - æ¨¡æ¿æ–‡ä»¶
â”‚   â””â”€â”€ æ¨¡æ¿.blend
â””â”€â”€ utils/                   # å¯é€‰ - å…¨å±€å·¥å…·</code></pre>

                <div class="warning">
                    <strong>é‡è¦</strong>: <code>rigs/</code> ç›®å½•æ˜¯Rigifyè¯†åˆ«çš„å…³é”®ï¼Œå¿…é¡»å­˜åœ¨ä¸”ç»“æ„æ­£ç¡®
                </div>

                <h3>2. ç±»ç»§æ‰¿å…³ç³»</h3>
                <pre><code>from rigify.base_rig import BaseRig

# ä¸»æ§åˆ¶å™¨ - å¿…é¡»ç»§æ‰¿BaseRig
class Rig(BaseRig):
    """ä¸»æ§åˆ¶å™¨ç±»"""
    
# å­æ§åˆ¶å™¨ - å¯ä»¥ç»§æ‰¿è‡ªå®šä¹‰åŸºç±»
class BaseFaceUPLocator(BaseRig):
    """è‡ªå®šä¹‰åŸºç¡€å®šä½å™¨ç±»"""
    
class Rig(BaseFaceUPLocator):
    """å­æ§åˆ¶å™¨ç»§æ‰¿è‡ªå®šä¹‰åŸºç±»"""</code></pre>

                <div class="warning">
                    <strong>æ³¨æ„</strong>: æ¯ä¸ªç»‘å®šæ–‡ä»¶å¿…é¡»åŒ…å«åä¸º <code>Rig</code> çš„ä¸»ç±»
                </div>

                <h3>3. æ–‡ä»¶å‘½åè§„èŒƒ</h3>
                <ul>
                    <li><strong>ä¸»æ§åˆ¶å™¨</strong>: <code>é¡¹ç›®å_ä¸»è¦åŠŸèƒ½.py</code></li>
                    <li><strong>å·¦å³å¯¹ç§°</strong>: <code>åŠŸèƒ½å_l.py</code> / <code>åŠŸèƒ½å_r.py</code></li>
                    <li><strong>å·¥å…·ç±»</strong>: <code>åŠŸèƒ½_utils.py</code> æˆ– <code>å·¥å…·å.py</code></li>
                </ul>

                <h3>4. Blenderç¯å¢ƒç‰¹æ®Šæ€§</h3>
                <div class="info">
                    ç”±äºBlenderçš„ç‰¹æ®Šè¿è¡Œç¯å¢ƒï¼š
                    <ul>
                        <li><strong>ä¸éœ€è¦ç”Ÿæˆæµ‹è¯•è„šæœ¬</strong> (é™¤éç”¨æˆ·å¼ºåˆ¶è¦æ±‚)</li>
                        <li><strong>æ— æ³•é€šè¿‡æ§åˆ¶å°ç›´æ¥è°ƒè¯•</strong></li>
                        <li><strong>éœ€è¦æ‰‹åŠ¨åœ¨Blenderå†…è¿è¡Œæµ‹è¯•</strong></li>
                        <li><strong>é”™è¯¯ä¿¡æ¯ä¸»è¦é€šè¿‡æ§åˆ¶å°è¾“å‡º</strong></li>
                    </ul>
                </div>
            </section>

            <section id="é¡¹ç›®ç»“æ„è§„èŒƒ">
                <h2>é¡¹ç›®ç»“æ„è§„èŒƒ</h2>

                <h3>æ¨¡å—åŒ–è®¾è®¡åŸåˆ™</h3>
                <pre><code># ä¸»æ§åˆ¶å™¨ - ç»Ÿä¸€ç®¡ç†
class Rig(BaseRig):
    def __init__(self, generator, obj, bone_name, **params):
        super().__init__(generator, obj, bone_name, **params)
        # æ³¨å†Œå­å®šä½å™¨
        self.child_rigs = []
        
    def register_child_rig(self, child_rig):
        """æ³¨å†Œå­æ§åˆ¶å™¨"""
        self.child_rigs.append(child_rig)

# å­æ§åˆ¶å™¨ - ç‹¬ç«‹åŠŸèƒ½
class BaseFaceUPLocator(BaseRig):
    def register_to_faceup_controller(self):
        """å‘ä¸»æ§åˆ¶å™¨æ³¨å†Œè‡ªå·±"""
        # æŸ¥æ‰¾å¹¶æ³¨å†Œåˆ°ä¸»æ§åˆ¶å™¨</code></pre>

                <h3>é›†åˆç®¡ç†ç³»ç»Ÿ</h3>
                <pre><code>def create_bone_collections(self):
    """åˆ›å»ºéª¨éª¼é›†åˆ - ç»„ç»‡å’Œåˆ†ç±»éª¨éª¼"""
    collections = {
        'Neb_Face': {'ui_row': 1, 'color_set_id': 5},  # ä¸»è¦é¢éƒ¨ç³»ç»Ÿ
        'Neb_Con': {'ui_row': 2, 'color_set_id': 2},   # ä¸»æ§åˆ¶å™¨
        'Neb_MCH': {'ui_row': 3, 'color_set_id': 4},   # æœºåˆ¶éª¨éª¼
        'Neb_Disw': {'ui_row': 4, 'color_set_id': 3}   # è·ç¦»æƒé‡æ§åˆ¶
    }
    
    for name, props in collections.items():
        coll = self.generator.collection_manager.create_collection(name)
        coll.ui_row = props['ui_row']
        coll.color_set_id = props['color_set_id']</code></pre>
            </section>

            <section id="æ ¸å¿ƒåŠŸèƒ½å‡½æ•°è¯¦è§£">
                <h2>æ ¸å¿ƒåŠŸèƒ½å‡½æ•°è¯¦è§£</h2>

                <h3>1. <code>generate_bones()</code> - éª¨éª¼ç”Ÿæˆå‡½æ•°</h3>
                <p><strong>ä½œç”¨</strong>: åˆ›å»ºç»‘å®šæ‰€éœ€çš„æ‰€æœ‰éª¨éª¼ç»“æ„</p>

                <pre><code>def generate_bones(self):
    """éª¨éª¼ç”Ÿæˆé˜¶æ®µ - Rigifyç”Ÿæˆæµç¨‹ç¬¬ä¸€æ­¥"""
    
    # 1. åˆ›å»ºæ ¹éª¨éª¼
    root_name = self.copy_bone(self.bones.org, "ä¸»æ ¹éª¨éª¼")
    
    # 2. åˆ›å»ºæ§åˆ¶éª¨éª¼
    control_name = self.copy_bone(self.bones.org, "æ§åˆ¶å™¨éª¨éª¼")
    
    # 3. åˆ›å»ºæœºåˆ¶éª¨éª¼ (MCH)
    mch_name = self.copy_bone(self.bones.org, "MCH-æœºåˆ¶éª¨éª¼")
    
    # 4. åˆ›å»ºå˜å½¢éª¨éª¼ (DEF) - å¯é€‰
    def_name = self.copy_bone(self.bones.org, "DEF-å˜å½¢éª¨éª¼")
    
    # 5. ä¿å­˜éª¨éª¼å¼•ç”¨ä»¥ä¾›åç»­ä½¿ç”¨
    self.bones.ctrl = control_name
    self.bones.mch = mch_name
    
    # 6. è®¾ç½®éª¨éª¼åŸºæœ¬å±æ€§
    self.get_bone(control_name).use_deform = False  # æ§åˆ¶éª¨éª¼ä¸å‚ä¸å˜å½¢
    self.get_bone(mch_name).use_deform = False      # æœºåˆ¶éª¨éª¼ä¸å‚ä¸å˜å½¢</code></pre>

                <div class="info">
                    <strong>å…³é”®è¦ç‚¹</strong>:
                    <ul>
                        <li>å¿…é¡»åœ¨æ‰€æœ‰ç»‘å®šç±»ä¸­å®ç°</li>
                        <li>åªåˆ›å»ºéª¨éª¼ï¼Œä¸è®¾ç½®çº¦æŸæˆ–çˆ¶å­å…³ç³»</li>
                        <li>ä½¿ç”¨ <code>self.copy_bone()</code> å¤åˆ¶ç°æœ‰éª¨éª¼</li>
                        <li>éª¨éª¼å‘½åè¦æœ‰æ„ä¹‰ä¸”å”¯ä¸€</li>
                    </ul>
                </div>

                <h3>2. <code>rig_bones()</code> - éª¨éª¼è£…é…å‡½æ•°</h3>
                <p><strong>ä½œç”¨</strong>: è®¾ç½®çº¦æŸç³»ç»Ÿã€éª¨éª¼åˆ†é…å’Œå±æ€§é…ç½®</p>

                <pre><code>def rig_bones(self):
    """éª¨éª¼è£…é…é˜¶æ®µ - è®¾ç½®çº¦æŸå’Œéª¨éª¼è¡Œä¸º"""
    
    # 1. åˆ†é…éª¨éª¼åˆ°é›†åˆ
    self.generator.collection_manager.assign_bone(
        self.bones.ctrl, 'Neb_Con'  # æ§åˆ¶å™¨éª¨éª¼ -> æ§åˆ¶å™¨é›†åˆ
    )
    
    # 2. è®¾ç½®å¤åˆ¶å˜æ¢çº¦æŸ
    if self.params.enable_copy_constraints:
        self.setup_copy_transform_constraints()
    
    # 3. ä»æ¨¡æ¿åŠ è½½çº¦æŸ
    if hasattr(self.params, 'load_constraints_from_template'):
        if self.params.load_constraints_from_template:
            self.load_constraints_from_template()
    
    # 4. è®¾ç½®é©±åŠ¨å™¨
    self.setup_drivers()
    
    # 5. é…ç½®éª¨éª¼é”å®š/è§£é”
    self.configure_bone_locks()</code></pre>

                <div class="info">
                    <strong>å…³é”®è¦ç‚¹</strong>:
                    <ul>
                        <li>åœ¨<code>generate_bones()</code>ä¹‹åæ‰§è¡Œ</li>
                        <li>è´Ÿè´£è®¾ç½®æ‰€æœ‰çº¦æŸå’Œé©±åŠ¨å™¨</li>
                        <li>ç®¡ç†éª¨éª¼çš„é›†åˆåˆ†é…</li>
                        <li>é…ç½®éª¨éª¼çš„å¯è§æ€§å’Œé”å®šçŠ¶æ€</li>
                    </ul>
                </div>

                <h3>3. <code>parent_bones()</code> - çˆ¶å­å…³ç³»å‡½æ•°</h3>
                <p><strong>ä½œç”¨</strong>: å»ºç«‹éª¨éª¼ä¹‹é—´çš„å±‚çº§å…³ç³»</p>

                <pre><code>def parent_bones(self):
    """è®¾ç½®éª¨éª¼çˆ¶å­å…³ç³» - å»ºç«‹éª¨éª¼å±‚çº§ç»“æ„"""
    
    # 1. è®¾ç½®ä¸»è¦å±‚çº§ç»“æ„
    self.set_bone_parent(self.bones.ctrl, self.bones.root)  # æ§åˆ¶å™¨ -> æ ¹éª¨éª¼
    
    # 2. è®¾ç½®æœºåˆ¶éª¨éª¼å±‚çº§
    for mch_bone in self.mch_bones:
        self.set_bone_parent(mch_bone, self.bones.mch_root)
    
    # 3. ç‰¹æ®Šçš„æƒé‡éª¨éª¼çˆ¶çº§è®¾ç½®
    for constraint_mapping in self.constraint_mappings:
        source_bone, neboffset_bone = constraint_mapping
        if self.get_bone(neboffset_bone):
            # è®¾ç½®NebOffsetéª¨éª¼çš„çˆ¶çº§ä¸ºç‰¹å®šæ ¹éª¨éª¼
            self.set_bone_parent(neboffset_bone, 'Neb_RigifyFace')
    
    # 4. å­æ§åˆ¶å™¨å±‚çº§
    for child_rig in self.child_rigs:
        child_rig.setup_parent_hierarchy()</code></pre>

                <div class="hierarchy">
                    <strong>å±‚çº§ç»“æ„ç¤ºä¾‹</strong>:<br>
                    Neb_Facer_root (é¡¹ç›®æ ¹)<br>
                    â”œâ”€â”€ Neb_face-root (é¢éƒ¨æ ¹)<br>
                    â”œâ”€â”€ Neb_RigifyFace (Rigifyé¢éƒ¨)<br>
                    â”‚   â””â”€â”€ NebOffset-* (æ‰€æœ‰æƒé‡éª¨éª¼)<br>
                    â””â”€â”€ brow-root.L/R (çœ‰æ¯›æ ¹)<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;â””â”€â”€ eyelip-root.L/R (çœ¼ç‘æ ¹)<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;â””â”€â”€ mouth-root (å˜´éƒ¨æ ¹)
                </div>

                <h3>4. <code>configure_bones()</code> - éª¨éª¼é…ç½®å‡½æ•°</h3>
                <p><strong>ä½œç”¨</strong>: é…ç½®éª¨éª¼çš„æ˜¾ç¤ºå±æ€§ã€é”å®šçŠ¶æ€ç­‰</p>

                <pre><code>def configure_bones(self):
    """é…ç½®éª¨éª¼å±æ€§å’Œæ˜¾ç¤º"""
    
    # 1. è®¾ç½®æ§åˆ¶å™¨éª¨éª¼å±æ€§
    ctrl_bone = self.get_bone(self.bones.ctrl)
    ctrl_bone.lock_location = (True, True, False)  # é”å®šX,Yè½´ç§»åŠ¨
    ctrl_bone.lock_rotation = (False, False, True) # é”å®šZè½´æ—‹è½¬
    ctrl_bone.lock_scale = (True, True, True)      # é”å®šæ‰€æœ‰ç¼©æ”¾
    
    # 2. è®¾ç½®éª¨éª¼é¢œè‰²å’Œå½¢çŠ¶
    pose_bone = self.obj.pose.bones.get(self.bones.ctrl)
    if pose_bone:
        pose_bone.custom_shape = self.load_widget('æ§åˆ¶å™¨å½¢çŠ¶')
        pose_bone.bone_group_index = 1  # è®¾ç½®éª¨éª¼ç»„
    
    # 3. éšè—æœºåˆ¶éª¨éª¼
    for mch_bone in self.mch_bones:
        bone = self.get_bone(mch_bone)
        bone.hide = True  # åœ¨ç¼–è¾‘æ¨¡å¼éšè—
        
        pose_bone = self.obj.pose.bones.get(mch_bone)
        if pose_bone:
            pose_bone.bone.hide = True  # åœ¨å§¿æ€æ¨¡å¼éšè—</code></pre>
            </section>

            <section id="å‚æ•°ç³»ç»Ÿä½¿ç”¨">
                <h2>å‚æ•°ç³»ç»Ÿä½¿ç”¨</h2>

                <h3>å‚æ•°å®šä¹‰</h3>
                <pre><code>@staticmethod
def add_parameters(params):
    """æ·»åŠ ç”¨æˆ·å¯é…ç½®å‚æ•°"""
    
    # åŸºç¡€å¼€å…³å‚æ•°
    params.enable_copy_constraints = BoolProperty(
        name="å¯ç”¨å¤åˆ¶çº¦æŸ",
        description="æ˜¯å¦å¯ç”¨å¤åˆ¶å˜æ¢çº¦æŸ",
        default=True
    )
    
    # æ•°å€¼å‚æ•°
    params.constraint_influence = FloatProperty(
        name="çº¦æŸå½±å“",
        description="çº¦æŸçš„å½±å“æƒé‡",
        default=1.0,
        min=0.0,
        max=1.0
    )
    
    # æšä¸¾å‚æ•°
    params.constraint_mix_mode = EnumProperty(
        name="æ··åˆæ¨¡å¼",
        description="çº¦æŸçš„æ··åˆæ¨¡å¼",
        items=[
            ('BEFORE', "ä¹‹å‰", "åœ¨ç°æœ‰å˜æ¢ä¹‹å‰åº”ç”¨"),
            ('AFTER', "ä¹‹å", "åœ¨ç°æœ‰å˜æ¢ä¹‹ååº”ç”¨"),
            ('REPLACE', "æ›¿æ¢", "æ›¿æ¢ç°æœ‰å˜æ¢")
        ],
        default='BEFORE'
    )</code></pre>

                <h3>å‚æ•°ä½¿ç”¨</h3>
                <pre><code>def generate_bones(self):
    # è¯»å–ç”¨æˆ·å‚æ•°
    if self.params.enable_copy_constraints:
        # æ‰§è¡Œçº¦æŸç›¸å…³é€»è¾‘
        pass
    
    # ä½¿ç”¨æ•°å€¼å‚æ•°
    influence = self.params.constraint_influence
    
    # ä½¿ç”¨åæ ‡å‚æ•°
    if hasattr(self.params, 'use_custom_positions') and self.params.use_custom_positions:
        custom_pos = Vector((
            self.params.disw_t_001_x,
            self.params.disw_t_001_y,
            self.params.disw_t_001_z
        ))</code></pre>
            </section>

            <section id="çº¦æŸå’Œé©±åŠ¨å™¨ç®¡ç†">
                <h2>çº¦æŸå’Œé©±åŠ¨å™¨ç®¡ç†</h2>

                <h3>çº¦æŸåˆ›å»ºå’Œé…ç½®</h3>
                <pre><code>def create_constraint(self, bone_name, constraint_type, **kwargs):
    """åˆ›å»ºçº¦æŸçš„é€šç”¨æ–¹æ³•"""
    pose_bone = self.obj.pose.bones.get(bone_name)
    if not pose_bone:
        print(f"è­¦å‘Š: éª¨éª¼ {bone_name} ä¸å­˜åœ¨")
        return None
    
    constraint = pose_bone.constraints.new(constraint_type)
    
    # è®¾ç½®çº¦æŸå±æ€§
    for prop, value in kwargs.items():
        if hasattr(constraint, prop):
            setattr(constraint, prop, value)
    
    return constraint

# ä½¿ç”¨ç¤ºä¾‹
def setup_limit_constraints(self):
    """è®¾ç½®é™åˆ¶çº¦æŸ"""
    self.create_constraint(
        self.bones.ctrl,
        'LIMIT_LOCATION',
        use_min_x=True, min_x=-0.1,
        use_max_x=True, max_x=0.1,
        owner_space='LOCAL'
    )</code></pre>

                <h3>é©±åŠ¨å™¨ç®¡ç†</h3>
                <pre><code>def create_driver(self, target_bone, property_path, expression=""):
    """åˆ›å»ºé©±åŠ¨å™¨"""
    driver = self.obj.pose.bones[target_bone].driver_add(property_path)
    
    if expression:
        driver.driver.expression = expression
    
    return driver

# ä½¿ç”¨ç¤ºä¾‹
def setup_facial_drivers(self):
    """è®¾ç½®é¢éƒ¨é©±åŠ¨å™¨"""
    # çœ‰æ¯›é«˜åº¦é©±åŠ¨å™¨
    driver = self.create_driver(
        'brow-control.L',
        'location',
        'ctrl_influence * 0.5'
    )
    
    # æ·»åŠ é©±åŠ¨å™¨å˜é‡
    var = driver.driver.variables.new()
    var.name = 'ctrl_influence'
    var.targets[0].id = self.obj
    var.targets[0].bone_target = 'main-control'
    var.targets[0].transform_type = 'LOC_Z'</code></pre>
            </section>

            <section id="è°ƒè¯•å’Œé”™è¯¯å¤„ç†">
                <h2>è°ƒè¯•å’Œé”™è¯¯å¤„ç†</h2>

                <h3>è°ƒè¯•ä¿¡æ¯è¾“å‡º</h3>
                <pre><code>def debug_print(self, message, level="INFO"):
    """ç»Ÿä¸€çš„è°ƒè¯•ä¿¡æ¯è¾“å‡º"""
    prefix = f"[{self.__class__.__name__}] {level}: "
    print(f"{prefix}{message}")

# ä½¿ç”¨ç¤ºä¾‹
def generate_bones(self):
    self.debug_print("å¼€å§‹ç”Ÿæˆéª¨éª¼")
    
    # è¯¦ç»†çš„è¿›åº¦ä¿¡æ¯
    self.debug_print(f"å‚æ•°çŠ¶æ€: enable_copy_constraints={self.params.enable_copy_constraints}")
    
    bone_count = len(self.bones_to_create)
    self.debug_print(f"è®¡åˆ’åˆ›å»º {bone_count} ä¸ªéª¨éª¼")</code></pre>

                <h3>é”™è¯¯å¤„ç†æœ€ä½³å®è·µ</h3>
                <pre><code>def safe_bone_operation(self, bone_name, operation):
    """å®‰å…¨çš„éª¨éª¼æ“ä½œåŒ…è£…å™¨"""
    try:
        bone = self.get_bone(bone_name)
        if not bone:
            self.debug_print(f"éª¨éª¼ {bone_name} ä¸å­˜åœ¨", "WARNING")
            return False
        
        operation(bone)
        return True
        
    except Exception as e:
        self.debug_print(f"éª¨éª¼ {bone_name} æ“ä½œå¤±è´¥: {str(e)}", "ERROR")
        return False

# ä½¿ç”¨ç¤ºä¾‹
def configure_bones(self):
    def set_bone_locks(bone):
        bone.lock_location = (True, True, False)
    
    self.safe_bone_operation(self.bones.ctrl, set_bone_locks)</code></pre>
            </section>

            <section id="æœ€ä½³å®è·µ">
                <h2>æœ€ä½³å®è·µ</h2>

                <h3>1. ä»£ç ç»„ç»‡</h3>
                <ul>
                    <li><strong>å•ä¸€èŒè´£</strong>: æ¯ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹</li>
                    <li><strong>æ¨¡å—åŒ–</strong>: ç›¸å…³åŠŸèƒ½ç»„ç»‡åœ¨ä¸€èµ·</li>
                    <li><strong>å¯æ‰©å±•</strong>: è®¾è®¡æ—¶è€ƒè™‘æœªæ¥çš„æ‰©å±•éœ€æ±‚</li>
                </ul>

                <h3>2. æ€§èƒ½ä¼˜åŒ–</h3>
                <pre><code># ç¼“å­˜ç»å¸¸è®¿é—®çš„å¯¹è±¡
def __init__(self, generator, obj, bone_name, **params):
    super().__init__(generator, obj, bone_name, **params)
    self._pose_bones_cache = {}

def get_pose_bone_cached(self, bone_name):
    """ç¼“å­˜å§¿æ€éª¨éª¼è®¿é—®"""
    if bone_name not in self._pose_bones_cache:
        self._pose_bones_cache[bone_name] = self.obj.pose.bones.get(bone_name)
    return self._pose_bones_cache[bone_name]</code></pre>

                <h3>3. ç”¨æˆ·ä½“éªŒ</h3>
                <ul>
                    <li><strong>æœ‰æ„ä¹‰çš„å‚æ•°åç§°å’Œæè¿°</strong></li>
                    <li><strong>åˆç†çš„é»˜è®¤å€¼</strong></li>
                    <li><strong>æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯</strong></li>
                    <li><strong>è¿›åº¦åé¦ˆ</strong></li>
                </ul>

                <h3>4. å…¼å®¹æ€§è€ƒè™‘</h3>
                <pre><code>def ensure_blender_compatibility(self):
    """ç¡®ä¿Blenderç‰ˆæœ¬å…¼å®¹æ€§"""
    import bpy
    
    if bpy.app.version < (4, 1, 0):
        raise Exception("éœ€è¦Blender 4.1æˆ–æ›´é«˜ç‰ˆæœ¬")
    
    # æ£€æŸ¥å¿…éœ€çš„æ’ä»¶
    if 'rigify' not in bpy.context.preferences.addons:
        raise Exception("éœ€è¦å¯ç”¨Rigifyæ’ä»¶")</code></pre>
            </section>

            <section id="æ€»ç»“">
                <h2>æ€»ç»“</h2>

                <div class="success">
                    å¼€å‘Rigifyæ‰©å±•éœ€è¦æŒæ¡ï¼š
                    <ol>
                        <li><strong>æ ¸å¿ƒå‡½æ•°æµç¨‹</strong>: <code>generate_bones()</code> â†’ <code>rig_bones()</code> â†’ <code>parent_bones()</code> â†’ <code>configure_bones()</code></li>
                        <li><strong>å‚æ•°ç³»ç»Ÿ</strong>: ä¸ºç”¨æˆ·æä¾›çµæ´»çš„é…ç½®é€‰é¡¹</li>
                        <li><strong>çº¦æŸç®¡ç†</strong>: æ­£ç¡®è®¾ç½®éª¨éª¼çº¦æŸå’Œé©±åŠ¨å™¨</li>
                        <li><strong>é”™è¯¯å¤„ç†</strong>: ä¼˜é›…åœ°å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ</li>
                        <li><strong>è°ƒè¯•æŠ€å·§</strong>: æœ‰æ•ˆçš„è°ƒè¯•å’ŒéªŒè¯æ–¹æ³•</li>
                    </ol>
                </div>

                <p>éµå¾ªè¿™äº›æŒ‡å¯¼åŸåˆ™ï¼Œæ‚¨å°±èƒ½å¼€å‘å‡ºç¨³å®šã€å¯é çš„Rigifyæ‰©å±•ã€‚è®°ä½ï¼ŒBlenderç¯å¢ƒçš„ç‰¹æ®Šæ€§è¦æ±‚æˆ‘ä»¬æ›´åŠ é‡è§†ä»£ç çš„å¥å£®æ€§å’Œè°ƒè¯•ä¿¡æ¯çš„å®Œæ•´æ€§ã€‚</p>
            </section>
        </main>
    </div>

    <script>
        // å¹³æ»‘æ»šåŠ¨åˆ°é”šç‚¹
        document.querySelectorAll('.toc a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // é«˜äº®å½“å‰ç« èŠ‚
        function highlightCurrentSection() {
            const sections = document.querySelectorAll('section[id]');
            const tocLinks = document.querySelectorAll('.toc a');
            
            let currentSection = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop - 100;
                if (window.scrollY >= sectionTop) {
                    currentSection = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.style.backgroundColor = '';
                link.style.color = '';
                if (link.getAttribute('href') === `#${currentSection}`) {
                    link.style.backgroundColor = '#3498db';
                    link.style.color = 'white';
                }
            });
        }

        // ç›‘å¬æ»šåŠ¨äº‹ä»¶
        window.addEventListener('scroll', highlightCurrentSection);
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', highlightCurrentSection);
    </script>
</body>
</html> 